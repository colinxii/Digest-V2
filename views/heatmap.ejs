<%
// Configuration
const daysOfWeek = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// Create a map for quick lookup of appointment counts by date
const appointmentMap = {};
appointmentData.forEach(item => {
const dateKey = `${item.Year}-${item.Month}-${item.Day}`;
  appointmentMap[dateKey] = item.Count;
});

// Calculate statistics
let totalAppointments = 0;
let maxCount = 0;
appointmentData.forEach(item => {
  if (item.Count > maxCount) maxCount = item.Count;
  totalAppointments += item.Count;
});

// Define color thresholds with fixed ranges
const colorThresholds = [
  { max: 0, color: "#ECECEC", label: "0" },
  { max: 1, color: "#C6E48B", label: "1" },
  { max: 2, color: "#7BC96F", label: "2" },
  { max: 3, color: "#239A3B", label: "3" },
  { max: Infinity, color: "#196127", label: "4+" }
];

// Helper function to get color based on count
const getColorForCount = (count) => {
  if (!count) return colorThresholds[0].color;
  for (let i = 1; i < colorThresholds.length; i++) {
    if (count <= colorThresholds[i].max) {
      return colorThresholds[i].color;
    }
  }
  return colorThresholds[colorThresholds.length - 1].color;
};

// Calculate date ranges
const today = new Date();
const endDate = new Date(today);
const startDate = new Date(today);
startDate.setDate(today.getDate() - 364);

// Adjust to start of week
const dayOfWeek = startDate.getDay();
const adjustedStartDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
startDate.setDate(startDate.getDate() - adjustedStartDay);

// Calculate weeks needed
const totalDays = Math.ceil((endDate - startDate) / (24 * 60 * 60 * 1000)) + adjustedStartDay;
const numWeeks = Math.ceil(totalDays / 7);

// Prepare weeks data
const weeksData = [];
const daysWithAppointments = Array(7).fill(false);

// Generate weeks data
for (let weekIndex = 0; weekIndex < numWeeks; weekIndex++) {
  const weekData = { days: [], hasMonth: false, monthName: "" };
  
  for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + (weekIndex * 7) + dayIndex);
    
    if (currentDate.getDate() === 1) {
      weekData.hasMonth = true;
      weekData.monthName = monthNames[currentDate.getMonth()];
    }
    
    const isWithinRange = currentDate >= startDate && currentDate <= endDate;
    
    if (isWithinRange) {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      const day = currentDate.getDate();
      const dateKey = `${year}-${month}-${day}`;
      const count = appointmentMap[dateKey] || 0;
      
      if (count > 0) daysWithAppointments[dayIndex] = true;
      
      weekData.days.push({
        date: currentDate,
        day: day,
        month: month,
        year: year,
        count: count,
        color: getColorForCount(count),
        isWithinRange: true
      });
    } else {
      weekData.days.push({
        isWithinRange: false,
        color: "#FFFFFF"
      });
    }
  }
  weeksData.push(weekData);
}

// Get active days
const activeDaysIndices = daysWithAppointments
  .map((hasAppointments, index) => hasAppointments ? index : -1)
  .filter(index => index !== -1);
const activeDays = activeDaysIndices.map(index => daysOfWeek[index]);
%>

<!-- HEADER SECTION -->
<%
// Calculate appointment statistics for bento boxes
// Reuse existing 'today' variable declared above
const bentoCurrentMonth = today.getMonth() + 1;
const bentoCurrentYear = today.getFullYear();

// Helper function to get quarter from month
function getQuarter(month) {
  return Math.ceil(month / 3);
}

const currentQuarter = getQuarter(bentoCurrentMonth);

// Calculate last month and last quarter
const lastMonth = bentoCurrentMonth === 1 ? 12 : bentoCurrentMonth - 1;
const lastMonthYear = bentoCurrentMonth === 1 ? bentoCurrentYear - 1 : bentoCurrentYear;
const lastQuarter = currentQuarter === 1 ? 4 : currentQuarter - 1;
const lastQuarterYear = currentQuarter === 1 ? bentoCurrentYear - 1 : bentoCurrentYear;

// Calculate this month's appointments
let thisMonthAppointments = 0;
appointmentData.forEach(item => {
  if (item.Year === bentoCurrentYear && item.Month === bentoCurrentMonth) {
    thisMonthAppointments += item.Count;
  }
});

// Calculate this quarter's appointments
let thisQuarterAppointments = 0;
appointmentData.forEach(item => {
  if (item.Year === bentoCurrentYear && getQuarter(item.Month) === currentQuarter) {
    thisQuarterAppointments += item.Count;
  }
});

// Calculate year-to-date appointments
let yearToDateAppointments = 0;
appointmentData.forEach(item => {
  if (item.Year === bentoCurrentYear) {
    const itemDate = new Date(item.Year, item.Month - 1, item.Day);
    if (itemDate <= today) {
      yearToDateAppointments += item.Count;
    }
  }
});

// Calculate last month's appointments
let lastMonthAppointments = 0;
appointmentData.forEach(item => {
  if (item.Year === lastMonthYear && item.Month === lastMonth) {
    lastMonthAppointments += item.Count;
  }
});

// Calculate last quarter's appointments
let lastQuarterAppointments = 0;
appointmentData.forEach(item => {
  if (item.Year === lastQuarterYear && getQuarter(item.Month) === lastQuarter) {
    lastQuarterAppointments += item.Count;
  }
});

// Format numbers with commas
function formatNumber(num) {
  return num.toLocaleString('en-US');
}
%>

<!-- Bento Box Header -->
<table style="width: 100%; margin-bottom: 20px; border-collapse: separate; border-spacing: 0;">
  <!-- Row 1: Title Header -->
  <tr>
    <td colspan="100%" style="padding: 0 0 10px 0;">
      <div style="border: 1px solid #ccc; background-color: #ECECEC; border-radius: 10px; padding: 15px; text-align: center;">
        <div style="font-weight: bold; font-size: 18px; color: #333;">APPOINTMENTS</div>
        <div style="font-size: 12px; color: #666; margin-top: 2px;">(LAST 365 DAYS)</div>
      </div>
    </td>
  </tr>
  
  <!-- Row 2: Current Period Metrics -->
  <tr>
  <!-- Total Appointments -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 0;  vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">TOTAL</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(totalAppointments) %></div>
        </div>
      </div>
    </td>
    
    <!-- Year to Date -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">YEAR TO DATE</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(yearToDateAppointments) %></div>
        </div>
      </div>
    </td>
    
    <!-- Last Quarter -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">LAST QUARTER</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(lastQuarterAppointments) %></div>
        </div>
      </div>
    </td>

    <!-- This Quarter -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">THIS QUARTER</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(thisQuarterAppointments) %></div>
        </div>
      </div>
    </td>

    <!-- Last Month -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">LAST MONTH</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(lastMonthAppointments) %></div>
        </div>
      </div>
    </td>
    
    <!-- This Month -->
    <td style="width: 14.28%; padding: 0 1.25% 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">THIS MONTH</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(thisMonthAppointments) %></div>
        </div>
      </div>
    </td>
     
    <!-- Most in One Day -->
    <td style="width: 14.28%; padding: 0 20px 10px 1.25%; vertical-align: top;">
      <div style="border: 1px solid #ccc; background-color: #fff; border-radius: 10px; padding: 10px; text-align: center; height: 30px; width: 100%; display: table;">
        <div style="display: table-cell; vertical-align: middle;">
          <div style="font-size: 12px; color: #666; margin-bottom: 2px;">MOST IN ONE DAY</div>
          <div style="font-weight: bold; font-size: 16px; color: #333;"><%= formatNumber(maxCount) %></div>
        </div>
      </div>
    </td>
  </tr>
</table>

  <% if (activeDays.length === 0) { %>
    <div>No appointments found in the specified date range.</div>
  <% } else { %>
    <table cellpadding="0" cellspacing="2" border="0" style="table-layout: fixed; border-collapse: separate; width:100%">
      <!-- Month labels -->
      <tr style="height: 20px;">
        <td style="width: 30px;"></td>
        <% 
        // Get all visible cells in chronological order
        const visibleDays = [];
        weeksData.forEach(week => {
          week.days.forEach((day, dayIndex) => {
            if (day.isWithinRange && daysWithAppointments[dayIndex]) {
              visibleDays.push({...day, weekIndex: week});
            }
          });
        });

        // Calculate total columns
        const totalCols = weeksData.length * 4;

        // Calculate month spans based on weeks
        let monthSpans = [];
        let currentMonth = null;
        let startWeek = 0;

        weeksData.forEach((week, weekIndex) => {
          week.days.forEach(day => {
            if (day.isWithinRange) {
              if (day.date.getDate() === 1 || currentMonth === null) {
                if (currentMonth !== null) {
                  monthSpans.push({
                    name: monthNames[currentMonth],
                    startCol: startWeek * 4,
                    colSpan: (weekIndex - startWeek) * 4
                  });
                }
                currentMonth = day.date.getMonth();
                startWeek = weekIndex;
              }
            }
          });
        });

        // Add the last month
        if (currentMonth !== null) {
          monthSpans.push({
            name: monthNames[currentMonth],
            startCol: startWeek * 4,
            colSpan: (weeksData.length - startWeek) * 4
          });
        }
        
        // Render month labels
        monthSpans.forEach(month => { %>
          <td colspan="<%= month.colSpan %>" style="text-align: left; font-size: 14px; padding-left: 5px;"><%= month.name %></td>
        <% }); %>
      </tr>
      
      <!-- Days and cells -->
      <% for (let i = 0; i < activeDaysIndices.length; i++) {
        const dayIndex = activeDaysIndices[i]; %>
        <tr style="height:20px;">
          <td style="text-align: right; padding-right: 5px; font-size: 12px;" colspan="1"><%= daysOfWeek[dayIndex] %></td>
          <% for (let j = 0; j < weeksData.length; j++) {
            const day = weeksData[j].days[dayIndex];
            if (day.isWithinRange) { %>
              <td title="<%= monthNames[day.month-1] %> <%= day.day %>, <%= day.year %>: <%= day.count %> appointment<%= day.count !== 1 ? 's' : '' %>" colspan="4"
                  style="background-color: <%= day.color %>; padding: 0; margin: 0;"></td>
            <% } else { %>
              <td style="min-height: 11px; background-color: <%= day.color %>; padding: 0; margin: 0;" colspan="4"></td>
            <% }
          } %>
        </tr>
      <% } %>
    </table>
    
    <!-- Color legend -->
    <div style="margin-top: 15px;">
      <table cellpadding="3" cellspacing="1" border="0">
        <tr>
          <td style="font-size: 11px;">Less (<%= colorThresholds[0].label %>)</td>
          <% colorThresholds.forEach(threshold => { %>
            <td style="width: 11px; height: 11px; background-color: <%= threshold.color %>;"></td>
          <% }); %>
          <td style="font-size: 11px;">More (<%= colorThresholds[4].label %>)</td>
        </tr>
      </table>
    </div>
  <% } %>
